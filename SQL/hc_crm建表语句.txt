-- ======================================================
--  HomeComfort CRM 数据库
--  优化核心：表归属于 hc_crm 默认 Schema，表名前缀区分模块
--  数据库名：hc_crm
--  适配环境：MySQL 8.0+、DataGrip
-- ======================================================

-- 1. 创建总数据库
CREATE DATABASE IF NOT EXISTS hc_crm
  DEFAULT CHARACTER SET utf8mb4
  COLLATE utf8mb4_unicode_ci;
USE hc_crm;

-- ======================================================
--  系统管理模块（表名前缀：sys_）
-- ======================================================
CREATE TABLE sys_user (
  id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '用户ID',
  username VARCHAR(50) NOT NULL UNIQUE COMMENT '登录用户名',
  password VARCHAR(100) NOT NULL COMMENT '密码（BCrypt加密密文，禁止明文）',
  real_name VARCHAR(50) NOT NULL COMMENT '真实姓名',
  email VARCHAR(100) COMMENT '联系邮箱（可用于登录/找回密码）',
  phone VARCHAR(20) NOT NULL COMMENT '手机号（唯一约束建议业务层控制）',
  status TINYINT DEFAULT 1 COMMENT '状态(1启用 0禁用)',
  create_time DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  update_time DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  INDEX idx_phone (phone) COMMENT '手机号查询索引'
) ENGINE=InnoDB COMMENT='系统用户表';

CREATE TABLE sys_role (
  id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '角色ID',
  role_name VARCHAR(50) NOT NULL UNIQUE COMMENT '角色名称（如：管理员、门店经理）',
  description VARCHAR(255) COMMENT '角色描述',
  create_time DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  update_time DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间'
) ENGINE=InnoDB COMMENT='系统角色表';

CREATE TABLE sys_permission (
  id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '权限ID',
  permission_name VARCHAR(100) NOT NULL COMMENT '权限名称（如：门店管理-查看）',
  path VARCHAR(255) NOT NULL COMMENT '权限路径（菜单URL/接口路径）',
  type VARCHAR(20) NOT NULL COMMENT '权限类型(menu=菜单/api=接口)',
  parent_id BIGINT COMMENT '父权限ID（用于菜单层级）',
  create_time DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  update_time DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  UNIQUE KEY uk_permission_path (path) COMMENT '权限路径唯一',
  FOREIGN KEY (parent_id) REFERENCES sys_permission(id) ON DELETE SET NULL
) ENGINE=InnoDB COMMENT='权限表';

CREATE TABLE sys_module (
  id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '模块ID',
  module_name VARCHAR(100) NOT NULL COMMENT '模块名称（如：门店管理、费用管理）',
  parent_id BIGINT DEFAULT NULL COMMENT '父模块ID（用于模块层级）',
  sort INT DEFAULT 0 COMMENT '排序序号（越小越靠前）',
  create_time DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  update_time DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  FOREIGN KEY (parent_id) REFERENCES sys_module(id) ON DELETE SET NULL
) ENGINE=InnoDB COMMENT='系统模块表';

CREATE TABLE sys_user_role (
  user_id BIGINT NOT NULL COMMENT '用户ID',
  role_id BIGINT NOT NULL COMMENT '角色ID',
  PRIMARY KEY (user_id, role_id) COMMENT '联合主键避免重复关联',
  FOREIGN KEY (user_id) REFERENCES sys_user(id) ON DELETE CASCADE,
  FOREIGN KEY (role_id) REFERENCES sys_role(id) ON DELETE CASCADE
) ENGINE=InnoDB COMMENT='用户角色关联表';

CREATE TABLE sys_role_permission (
  role_id BIGINT NOT NULL COMMENT '角色ID',
  permission_id BIGINT NOT NULL COMMENT '权限ID',
  PRIMARY KEY (role_id, permission_id) COMMENT '联合主键避免重复授权',
  FOREIGN KEY (role_id) REFERENCES sys_role(id) ON DELETE CASCADE,
  FOREIGN KEY (permission_id) REFERENCES sys_permission(id) ON DELETE CASCADE
) ENGINE=InnoDB COMMENT='角色权限关联表';

-- ======================================================
--  门店管理模块（表名前缀：store_）
-- ======================================================
CREATE TABLE store (
  id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '门店ID',
  store_code VARCHAR(50) NOT NULL UNIQUE COMMENT '门店编码（系统唯一标识）',
  store_name VARCHAR(100) NOT NULL COMMENT '门店名称',
  province VARCHAR(50) NOT NULL COMMENT '所在省份',
  city VARCHAR(50) NOT NULL COMMENT '所在城市',
  district VARCHAR(50) COMMENT '所在区县',
  address VARCHAR(255) NOT NULL COMMENT '详细地址',
  contact_name VARCHAR(50) COMMENT '门店联系人',
  contact_phone VARCHAR(20) COMMENT '联系人电话',
  status TINYINT DEFAULT 1 COMMENT '状态(1启用 0停用)',
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  INDEX idx_province_city (province, city) COMMENT '按省市筛选门店',
  INDEX idx_status (status) COMMENT '按状态筛选门店'
) ENGINE=InnoDB COMMENT='门店主数据';

CREATE TABLE store_promoter (
  id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '促销员ID',
  store_id BIGINT NOT NULL COMMENT '所属门店ID',
  name VARCHAR(50) NOT NULL COMMENT '促销员姓名',
  phone VARCHAR(20) NOT NULL COMMENT '促销员电话',
  id_card VARCHAR(20) COMMENT '身份证号',
  hire_date DATE NOT NULL COMMENT '入职日期',
  leave_date DATE COMMENT '离职日期（NULL表示在职）',
  status TINYINT DEFAULT 1 COMMENT '状态(1在职 0离职)',
  remark VARCHAR(255) COMMENT '备注',
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  FOREIGN KEY (store_id) REFERENCES store(id) ON DELETE RESTRICT,
  INDEX idx_store_id (store_id) COMMENT '按门店查询促销员',
  UNIQUE KEY uk_phone (phone) COMMENT '促销员手机号唯一'
) ENGINE=InnoDB COMMENT='促销员表';

CREATE TABLE store_target (
  id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '销售目标ID',
  store_id BIGINT NOT NULL COMMENT '门店ID',
  year INT NOT NULL COMMENT '目标年份（如：2024）',
  quarter TINYINT COMMENT '目标季度（1-4，NULL表示全年）',
  month INT COMMENT '目标月份（1-12，NULL表示季度/全年）',
  target_type VARCHAR(20) NOT NULL COMMENT '目标类型（sales=销售额/volume=销量）',
  target_value DECIMAL(12,2) NOT NULL COMMENT '目标值',
  achieved_value DECIMAL(12,2) DEFAULT 0 COMMENT '已完成值',
  update_time DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  FOREIGN KEY (store_id) REFERENCES store(id) ON DELETE RESTRICT,
  UNIQUE KEY uk_store_time_type (store_id, year, quarter, month, target_type) COMMENT '同一门店同一时间维度目标唯一'
) ENGINE=InnoDB COMMENT='门店销售目标表';

CREATE TABLE store_application (
  id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '申请ID',
  store_id BIGINT NOT NULL COMMENT '门店ID',
  type VARCHAR(50) NOT NULL COMMENT '申请类型（renovation=翻新/online=上官网/close=关闭）',
  reason TEXT NOT NULL COMMENT '申请理由',
  status TINYINT DEFAULT 0 COMMENT '状态(0待审批 1通过 2驳回 3已完成)',
  apply_time DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '申请时间',
  approver_id BIGINT COMMENT '审批人ID',
  approve_time DATETIME COMMENT '审批时间',
  update_time DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  FOREIGN KEY (store_id) REFERENCES store(id) ON DELETE RESTRICT,
  FOREIGN KEY (approver_id) REFERENCES sys_user(id) ON DELETE SET NULL,
  INDEX idx_store_status (store_id, status) COMMENT '按门店+状态查询申请',
  UNIQUE KEY uk_store_type_pending (store_id, type, status) COMMENT '同一门店同一类型未完成申请不可重复'
) ENGINE=InnoDB COMMENT='门店申请表';

CREATE TABLE store_upgrade (
  id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '翻新记录ID',
  store_id BIGINT NOT NULL COMMENT '门店ID',
  upgrade_type VARCHAR(50) COMMENT '翻新类型（decorate=装修/equipment=设备更新）',
  upgrade_time DATETIME NOT NULL COMMENT '翻新完成时间',
  cost DECIMAL(12,2) COMMENT '翻新费用',
  remarks VARCHAR(255) COMMENT '备注（如：翻新区域、材料）',
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  FOREIGN KEY (store_id) REFERENCES store(id) ON DELETE RESTRICT,
  INDEX idx_store_id (store_id) COMMENT '按门店查询翻新记录'
) ENGINE=InnoDB COMMENT='门店翻新升级记录';

CREATE TABLE store_online_status (
  id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '状态ID',
  store_id BIGINT NOT NULL COMMENT '门店ID',
  is_online TINYINT DEFAULT 0 COMMENT '是否上线（1=上线 0=下线）',
  action_time DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '操作时间',
  operator_id BIGINT COMMENT '操作人ID',
  remarks VARCHAR(255) COMMENT '备注',
  FOREIGN KEY (store_id) REFERENCES store(id) ON DELETE RESTRICT,
  FOREIGN KEY (operator_id) REFERENCES sys_user(id) ON DELETE SET NULL,
  UNIQUE KEY uk_store_current (store_id, is_online) COMMENT '同一门店当前上线状态唯一'
) ENGINE=InnoDB COMMENT='门店上/下官网状态表';

CREATE TABLE store_close (
  id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '关闭记录ID',
  store_id BIGINT NOT NULL COMMENT '门店ID',
  close_type VARCHAR(50) COMMENT '关闭类型（close=永久关闭/downgrade=降级）',
  close_reason VARCHAR(255) NOT NULL COMMENT '关闭理由',
  close_time DATETIME NOT NULL COMMENT '关闭时间',
  operator_id BIGINT COMMENT '操作人ID',
  remarks VARCHAR(255) COMMENT '备注',
  FOREIGN KEY (store_id) REFERENCES store(id) ON DELETE RESTRICT,
  FOREIGN KEY (operator_id) REFERENCES sys_user(id) ON DELETE SET NULL
) ENGINE=InnoDB COMMENT='门店关闭/降级记录';

-- ======================================================
--  活动与促销模块（表名前缀：activity_）
-- ======================================================
CREATE TABLE activity_promotion (
  id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '活动ID',
  title VARCHAR(100) NOT NULL COMMENT '活动标题（如：2024夏季空调促销）',
  type VARCHAR(50) NOT NULL COMMENT '活动类型（full_reduction=满减/discount=折扣/gift=赠品）',
  start_date DATE NOT NULL COMMENT '活动开始日期',
  end_date DATE NOT NULL COMMENT '活动结束日期',
  content TEXT COMMENT '活动内容（规则说明）',
  status TINYINT DEFAULT 0 COMMENT '状态(0草稿 1待生效 2进行中 3已结束 4已取消)',
  created_by BIGINT NOT NULL COMMENT '创建人ID',
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  FOREIGN KEY (created_by) REFERENCES sys_user(id) ON DELETE RESTRICT,
  INDEX idx_status (status) COMMENT '按状态筛选活动',
  INDEX idx_date_range (start_date, end_date) COMMENT '按日期范围查询活动'
) ENGINE=InnoDB COMMENT='促销活动表';

CREATE TABLE activity_promotion_signup (
  id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '报名ID',
  promotion_id BIGINT NOT NULL COMMENT '活动ID',
  store_id BIGINT NOT NULL COMMENT '门店ID',
  signup_time DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '报名时间',
  status TINYINT DEFAULT 0 COMMENT '状态(0待确认 1已报名 2已取消)',
  contact_person VARCHAR(50) COMMENT '门店联系人',
  contact_phone VARCHAR(20) COMMENT '联系人电话',
  remarks VARCHAR(255) COMMENT '备注',
  FOREIGN KEY (promotion_id) REFERENCES activity_promotion(id) ON DELETE CASCADE,
  FOREIGN KEY (store_id) REFERENCES store(id) ON DELETE RESTRICT,
  UNIQUE KEY uk_promotion_store (promotion_id, store_id) COMMENT '同一门店不可重复报名同一活动',
  INDEX idx_promotion_status (promotion_id, status) COMMENT '按活动+状态查询报名'
) ENGINE=InnoDB COMMENT='活动报名表';

CREATE TABLE activity_promotion_followup (
  id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '跟进记录ID',
  promotion_id BIGINT NOT NULL COMMENT '活动ID',
  store_id BIGINT NOT NULL COMMENT '门店ID',
  follow_detail TEXT NOT NULL COMMENT '跟进详情（如：活动执行进度、问题反馈）',
  follow_time DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '跟进时间',
  user_id BIGINT NOT NULL COMMENT '跟进人ID',
  FOREIGN KEY (promotion_id) REFERENCES activity_promotion(id) ON DELETE CASCADE,
  FOREIGN KEY (store_id) REFERENCES store(id) ON DELETE RESTRICT,
  FOREIGN KEY (user_id) REFERENCES sys_user(id) ON DELETE RESTRICT,
  INDEX idx_promotion_store (promotion_id, store_id) COMMENT '按活动+门店查询跟进记录'
) ENGINE=InnoDB COMMENT='活动跟进记录表';

-- ======================================================
--  产品与物料模块（表名前缀：product_/material_）
-- ======================================================
CREATE TABLE product (
  id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '产品ID',
  product_code VARCHAR(50) NOT NULL UNIQUE COMMENT '产品编码（系统唯一）',
  product_name VARCHAR(100) NOT NULL COMMENT '产品名称',
  category VARCHAR(50) NOT NULL COMMENT '产品分类（如：空调/热水器/冰箱）',
  sub_category VARCHAR(50) COMMENT '子分类（如：壁挂式空调/立式空调）',
  model VARCHAR(50) NOT NULL COMMENT '产品型号',
  spec VARCHAR(100) COMMENT '产品规格（如：1.5匹/一级能效）',
  price DECIMAL(10,2) NOT NULL COMMENT '指导价',
  status TINYINT DEFAULT 1 COMMENT '状态(1在售 0下架)',
  create_time DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  update_time DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  INDEX idx_category (category, sub_category) COMMENT '按分类查询产品',
  INDEX idx_status (status) COMMENT '按状态筛选产品'
) ENGINE=InnoDB COMMENT='产品主数据表';

CREATE TABLE material (
  id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '物料ID',
  material_code VARCHAR(50) NOT NULL UNIQUE COMMENT '物料编码（系统唯一）',
  material_name VARCHAR(100) NOT NULL COMMENT '物料名称（如：宣传册/海报/展架）',
  type VARCHAR(50) NOT NULL COMMENT '物料类型（print=印刷品/display=展示物料）',
  spec VARCHAR(100) COMMENT '物料规格（如：A4/80cm*120cm）',
  unit VARCHAR(20) NOT NULL COMMENT '单位（如：本/张/个）',
  stock INT DEFAULT 0 COMMENT '当前库存',
  warn_stock INT DEFAULT 10 COMMENT '库存预警值',
  status TINYINT DEFAULT 1 COMMENT '状态(1可用 0禁用)',
  create_time DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  update_time DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  INDEX idx_type (type) COMMENT '按物料类型查询',
  INDEX idx_stock (stock) COMMENT '库存查询（用于预警）'
) ENGINE=InnoDB COMMENT='物料主数据表';

-- 物料入库记录表（补充：完善物料流转）
CREATE TABLE material_stock_in (
  id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '入库ID',
  material_id BIGINT NOT NULL COMMENT '物料ID',
  quantity INT NOT NULL COMMENT '入库数量',
  batch_no VARCHAR(50) COMMENT '批次号',
  operator_id BIGINT NOT NULL COMMENT '操作人ID',
  operation_time DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '入库时间',
  remarks VARCHAR(255) COMMENT '备注（如：采购入库/退货入库）',
  FOREIGN KEY (material_id) REFERENCES material(id) ON DELETE RESTRICT,
  FOREIGN KEY (operator_id) REFERENCES sys_user(id) ON DELETE RESTRICT,
  INDEX idx_material_id (material_id) COMMENT '按物料查询入库记录',
  INDEX idx_operation_time (operation_time) COMMENT '按时间查询入库记录'
) ENGINE=InnoDB COMMENT='物料入库记录表';

-- 物料出库记录表（补充：完善物料流转）
CREATE TABLE material_stock_out (
  id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '出库ID',
  material_id BIGINT NOT NULL COMMENT '物料ID',
  store_id BIGINT NOT NULL COMMENT '领用门店ID',
  quantity INT NOT NULL COMMENT '出库数量',
  operator_id BIGINT NOT NULL COMMENT '操作人ID',
  operation_time DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '出库时间',
  remarks VARCHAR(255) COMMENT '备注（如：门店活动领用）',
  FOREIGN KEY (material_id) REFERENCES material(id) ON DELETE RESTRICT,
  FOREIGN KEY (store_id) REFERENCES store(id) ON DELETE RESTRICT,
  FOREIGN KEY (operator_id) REFERENCES sys_user(id) ON DELETE RESTRICT,
  INDEX idx_material_store (material_id, store_id) COMMENT '按物料+门店查询出库记录'
) ENGINE=InnoDB COMMENT='物料出库记录表';

-- ======================================================
--  竞品信息模块（表名前缀：competitor_）
-- ======================================================
CREATE TABLE competitor_info (
  id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '竞品ID',
  store_id BIGINT NOT NULL COMMENT '上报门店ID',
  competitor_name VARCHAR(100) NOT NULL COMMENT '竞品品牌名称（如：美的/格力）',
  product_name VARCHAR(100) NOT NULL COMMENT '竞品产品名称',
  product_category VARCHAR(50) NOT NULL COMMENT '竞品分类（与自有产品分类一致）',
  model VARCHAR(50) COMMENT '竞品型号',
  spec VARCHAR(100) COMMENT '竞品规格',
  price DECIMAL(10,2) NOT NULL COMMENT '竞品售价',
  promotion_activity TEXT COMMENT '竞品促销活动（如：满减/赠品）',
  remarks VARCHAR(255) COMMENT '备注（如：销售渠道/用户评价）',
  created_by BIGINT COMMENT '上报人ID',
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  FOREIGN KEY (store_id) REFERENCES store(id) ON DELETE CASCADE,
  FOREIGN KEY (created_by) REFERENCES sys_user(id) ON DELETE SET NULL,
  INDEX idx_store_competitor (store_id, competitor_name) COMMENT '按门店+竞品品牌查询',
  INDEX idx_product_category (product_category) COMMENT '按分类查询竞品'
) ENGINE=InnoDB COMMENT='竞品信息表';

-- ======================================================
--  费用管理模块（表名前缀：finance_）
-- ======================================================
CREATE TABLE finance_budget (
  id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '预算ID',
  year INT NOT NULL COMMENT '预算年份（如：2024）',
  quarter TINYINT COMMENT '预算季度（1-4，NULL表示全年）',
  department VARCHAR(100) NOT NULL COMMENT '预算部门（如：市场部/销售部）',
  budget_type VARCHAR(50) NOT NULL COMMENT '预算类型（activity=活动费/material=物料费/renovation=装修费）',
  total_budget DECIMAL(12,2) NOT NULL COMMENT '总预算金额',
  used_amount DECIMAL(12,2) DEFAULT 0 COMMENT '已使用金额',
  remaining_amount DECIMAL(12,2) GENERATED ALWAYS AS (total_budget - used_amount) STORED COMMENT '剩余预算（计算列）',
  update_time DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  UNIQUE KEY uk_year_quarter_dept_type (year, quarter, department, budget_type) COMMENT '同一维度预算唯一',
  INDEX idx_year_department (year, department) COMMENT '按年份+部门查询预算'
) ENGINE=InnoDB COMMENT='预算管理表';

CREATE TABLE finance_expense (
  id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '费用ID',
  expense_no VARCHAR(50) NOT NULL UNIQUE COMMENT '费用单号（系统生成）',
  store_id BIGINT NOT NULL COMMENT '门店ID',
  promotion_id BIGINT COMMENT '关联活动ID（NULL表示非活动费用）',
  budget_id BIGINT COMMENT '关联预算ID',
  amount DECIMAL(12,2) NOT NULL COMMENT '费用金额',
  expense_type VARCHAR(50) NOT NULL COMMENT '费用类型（与预算类型一致）',
  payment_method VARCHAR(50) COMMENT '支付方式（cash=现金/transfer=转账/wechat=微信）',
  apply_user BIGINT NOT NULL COMMENT '申请人ID',
  status TINYINT DEFAULT 0 COMMENT '状态(0待审批 1通过 2驳回 3已支付 4已核销 5已作废)',
  apply_time DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '申请时间',
  approve_time DATETIME COMMENT '审批时间',
  approver_id BIGINT COMMENT '审批人ID',
  payment_time DATETIME COMMENT '支付时间',
  remarks VARCHAR(255) COMMENT '备注（如：费用用途/发票号）',
  create_time DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  update_time DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  FOREIGN KEY (store_id) REFERENCES store(id) ON DELETE RESTRICT,
  FOREIGN KEY (promotion_id) REFERENCES activity_promotion(id) ON DELETE SET NULL,
  FOREIGN KEY (budget_id) REFERENCES finance_budget(id) ON DELETE SET NULL,
  FOREIGN KEY (apply_user) REFERENCES sys_user(id) ON DELETE RESTRICT,
  FOREIGN KEY (approver_id) REFERENCES sys_user(id) ON DELETE SET NULL,
  INDEX idx_store_status (store_id, status) COMMENT '按门店+状态查询费用',
  INDEX idx_apply_time (apply_time) COMMENT '按申请时间查询费用'
) ENGINE=InnoDB COMMENT='实际费用表';

CREATE TABLE finance_expense_report (
  id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '报表ID',
  report_no VARCHAR(50) NOT NULL UNIQUE COMMENT '报表编号',
  report_month VARCHAR(10) NOT NULL COMMENT '报表月份（格式：YYYY-MM）',
  department VARCHAR(100) COMMENT '部门（NULL表示全公司）',
  store_id BIGINT COMMENT '门店ID（NULL表示全部门店）',
  total_expense DECIMAL(12,2) NOT NULL COMMENT '总费用金额',
  expense_detail JSON COMMENT '费用明细（按类型统计，JSON格式）',
  created_by BIGINT NOT NULL COMMENT '生成人ID',
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '生成时间',
  UNIQUE KEY uk_report_month_dept_store (report_month, department, store_id) COMMENT '同一维度报表唯一',
  FOREIGN KEY (store_id) REFERENCES store(id) ON DELETE SET NULL,
  FOREIGN KEY (created_by) REFERENCES sys_user(id) ON DELETE RESTRICT
) ENGINE=InnoDB COMMENT='费用报表表';

-- ======================================================
--  消息管理模块（表名前缀：message_）
-- ======================================================
CREATE TABLE message_template (
  id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '模板ID',
  template_name VARCHAR(100) NOT NULL COMMENT '模板名称（如：活动报名成功通知）',
  template_type VARCHAR(50) NOT NULL COMMENT '模板类型（sms=短信/notice=系统通知/email=邮件）',
  content TEXT NOT NULL COMMENT '模板内容（支持变量替换，如：${storeName}）',
  status TINYINT DEFAULT 1 COMMENT '状态(1启用 0禁用)',
  create_time DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  update_time DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  UNIQUE KEY uk_template_name_type (template_name, template_type) COMMENT '同一类型模板名称唯一',
  INDEX idx_template_type (template_type) COMMENT '按类型查询模板'
) ENGINE=InnoDB COMMENT='消息模板表';

CREATE TABLE message_notification_group (
  id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '通知组ID',
  group_name VARCHAR(100) NOT NULL UNIQUE COMMENT '组名称（如：门店经理组/促销员组）',
  description VARCHAR(255) COMMENT '组描述',
  create_by BIGINT NOT NULL COMMENT '创建人ID',
  create_time DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  update_time DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  FOREIGN KEY (create_by) REFERENCES sys_user(id) ON DELETE RESTRICT
) ENGINE=InnoDB COMMENT='通知组表';

-- 通知组成员表（补充：关联用户与通知组）
CREATE TABLE message_notification_group_member (
  id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '关联ID',
  group_id BIGINT NOT NULL COMMENT '通知组ID',
  user_id BIGINT NOT NULL COMMENT '用户ID',
  join_time DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '加入时间',
  FOREIGN KEY (group_id) REFERENCES message_notification_group(id) ON DELETE CASCADE,
  FOREIGN KEY (user_id) REFERENCES sys_user(id) ON DELETE CASCADE,
  UNIQUE KEY uk_group_user (group_id, user_id) COMMENT '同一用户不可重复加入同一组'
) ENGINE=InnoDB COMMENT='通知组成员表';

-- 消息发送记录表（补充：追踪消息发送状态）
CREATE TABLE message_record (
  id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '记录ID',
  template_id BIGINT COMMENT '模板ID（NULL表示自定义消息）',
  group_id BIGINT COMMENT '通知组ID（NULL表示单个用户）',
  user_id BIGINT COMMENT '单个用户ID（与group_id二选一）',
  message_type VARCHAR(50) NOT NULL COMMENT '消息类型（与模板类型一致）',
  content TEXT NOT NULL COMMENT '实际发送内容',
  status TINYINT DEFAULT 0 COMMENT '发送状态(0待发送 1发送成功 2发送失败)',
  send_time DATETIME COMMENT '发送时间',
  fail_reason VARCHAR(255) COMMENT '失败原因',
  create_time DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  FOREIGN KEY (template_id) REFERENCES message_template(id) ON DELETE SET NULL,
  FOREIGN KEY (group_id) REFERENCES message_notification_group(id) ON DELETE SET NULL,
  FOREIGN KEY (user_id) REFERENCES sys_user(id) ON DELETE SET NULL,
  INDEX idx_status (status) COMMENT '按发送状态查询',
  INDEX idx_send_time (send_time) COMMENT '按发送时间查询'
) ENGINE=InnoDB COMMENT='消息发送记录表';

-- ======================================================
--  智慧门店模块（表名前缀：smart_）
-- ======================================================
CREATE TABLE smart_sample_notice (
  id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '通知ID',
  notice_title VARCHAR(100) NOT NULL COMMENT '通知标题（如：2024夏季新品出样通知）',
  store_id BIGINT NOT NULL COMMENT '门店ID',
  notice_content TEXT NOT NULL COMMENT '通知内容（出样要求/时间节点）',
  require_time DATETIME COMMENT '要求完成时间',
  status TINYINT DEFAULT 0 COMMENT '状态(0未完成 1已完成 2逾期)',
  completion_time DATETIME COMMENT '实际完成时间',
  creator_id BIGINT NOT NULL COMMENT '创建人ID',
  create_time DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  update_time DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  FOREIGN KEY (store_id) REFERENCES store(id) ON DELETE RESTRICT,
  FOREIGN KEY (creator_id) REFERENCES sys_user(id) ON DELETE RESTRICT,
  INDEX idx_store_status (store_id, status) COMMENT '按门店+状态查询通知',
  INDEX idx_require_time (require_time) COMMENT '按要求时间查询'
) ENGINE=InnoDB COMMENT='出样通知表';

CREATE TABLE smart_data_audit (
  id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '审核ID',
  store_id BIGINT NOT NULL COMMENT '门店ID',
  data_type VARCHAR(50) NOT NULL COMMENT '数据类型（sales=销售数据/inventory=库存数据）',
  audit_period VARCHAR(10) NOT NULL COMMENT '审核周期（格式：YYYY-MM）',
  data_content JSON NOT NULL COMMENT '审核数据内容（JSON格式）',
  audit_status TINYINT DEFAULT 0 COMMENT '审核状态(0待审核 1审核通过 2审核驳回)',
  auditor_id BIGINT COMMENT '审核人ID',
  audit_time DATETIME COMMENT '审核时间',
  audit_comment TEXT COMMENT '审核意见',
  create_time DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  update_time DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  FOREIGN KEY (store_id) REFERENCES store(id) ON DELETE RESTRICT,
  FOREIGN KEY (auditor_id) REFERENCES sys_user(id) ON DELETE SET NULL,
  UNIQUE KEY uk_store_data_period (store_id, data_type, audit_period) COMMENT '同一门店同一类型同期数据唯一',
  INDEX idx_audit_status (audit_status) COMMENT '按审核状态查询'
) ENGINE=InnoDB COMMENT='数据审核表';

CREATE TABLE smart_order_activity_config (
  id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '配置ID',
  config_name VARCHAR(100) NOT NULL UNIQUE COMMENT '配置名称（如：批量录单满减活动）',
  config_type VARCHAR(50) NOT NULL COMMENT '配置类型（order_discount=录单折扣/order_gift=录单赠品）',
  trigger_condition JSON NOT NULL COMMENT '触发条件（JSON格式，如：{"minAmount":1000}）',
  reward_content JSON NOT NULL COMMENT '奖励内容（JSON格式，如：{"discount":0.9}）',
  status TINYINT DEFAULT 1 COMMENT '状态(1启用 0禁用)',
  start_time DATETIME NOT NULL COMMENT '生效时间',
  end_time DATETIME NOT NULL COMMENT '失效时间',
  create_time DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  update_time DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  INDEX idx_config_type (config_type) COMMENT '按配置类型查询',
  INDEX idx_status_time (status, start_time, end_time) COMMENT '按状态+时间查询生效配置'
) ENGINE=InnoDB COMMENT='录单活动配置表';

CREATE TABLE smart_batch_order (
  id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '批量录单ID',
  batch_no VARCHAR(100) NOT NULL UNIQUE COMMENT '批次号（系统生成）',
  upload_user BIGINT NOT NULL COMMENT '上传人ID',
  upload_time DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '上传时间',
  file_name VARCHAR(255) COMMENT '上传文件名',
  total_count INT DEFAULT 0 COMMENT '录单总数',
  success_count INT DEFAULT 0 COMMENT '成功数',
  fail_count INT DEFAULT 0 COMMENT '失败数',
  status TINYINT DEFAULT 0 COMMENT '状态(0上传中 1已完成 2部分失败 3全部失败)',
  remarks VARCHAR(255) COMMENT '备注',
  FOREIGN KEY (upload_user) REFERENCES sys_user(id) ON DELETE RESTRICT,
  INDEX idx_batch_no (batch_no) COMMENT '按批次号查询',
  INDEX idx_upload_time (upload_time) COMMENT '按上传时间查询'
) ENGINE=InnoDB COMMENT='批量录单表';

-- 批量录单明细表（补充：记录单条订单信息）
CREATE TABLE smart_batch_order_detail (
  id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '明细ID',
  batch_id BIGINT NOT NULL COMMENT '批量录单ID',
  order_no VARCHAR(50) COMMENT '订单号（系统生成/外部订单号）',
  product_id BIGINT NOT NULL COMMENT '产品ID',
  product_name VARCHAR(100) NOT NULL COMMENT '产品名称（冗余，避免关联查询）',
  quantity INT NOT NULL COMMENT '下单数量',
  unit_price DECIMAL(10,2) NOT NULL COMMENT '单价',
  total_price DECIMAL(12,2) NOT NULL COMMENT '总价',
  customer_name VARCHAR(50) COMMENT '客户姓名',
  customer_phone VARCHAR(20) COMMENT '客户电话',
  status TINYINT DEFAULT 1 COMMENT '状态(1成功 0失败)',
  fail_reason VARCHAR(255) COMMENT '失败原因（如：产品不存在/库存不足）',
  create_time DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  FOREIGN KEY (batch_id) REFERENCES smart_batch_order(id) ON DELETE CASCADE,
  FOREIGN KEY (product_id) REFERENCES product(id) ON DELETE RESTRICT,
  INDEX idx_batch_id (batch_id) COMMENT '按批量录单ID查询明细',
  INDEX idx_status (status) COMMENT '按状态筛选成功/失败订单'
) ENGINE=InnoDB COMMENT='批量录单明细表';

-- ======================================================
--  通用审批流模块（表名前缀：approval_）
-- ======================================================
CREATE TABLE approval (
  id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '审批ID',
  approval_no VARCHAR(50) NOT NULL UNIQUE COMMENT '审批单号（系统生成）',
  related_type VARCHAR(50) NOT NULL COMMENT '关联业务类型（expense=费用申请/store_apply=门店申请）',
  related_id BIGINT NOT NULL COMMENT '关联业务ID（如：费用ID/门店申请ID）',
  applicant_id BIGINT NOT NULL COMMENT '申请人ID',
  applicant_name VARCHAR(50) NOT NULL COMMENT '申请人姓名（冗余）',
  status TINYINT DEFAULT 0 COMMENT '审批状态(0审批中 1通过 2驳回 3撤回 4已作废)',
  current_node VARCHAR(50) COMMENT '当前审批节点（如：部门经理/财务）',
  priority TINYINT DEFAULT 2 COMMENT '优先级(1紧急 2普通 3低)',
  create_time DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  update_time DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  FOREIGN KEY (applicant_id) REFERENCES sys_user(id) ON DELETE RESTRICT,
  UNIQUE KEY uk_related_type_id (related_type, related_id) COMMENT '同一业务只能有一条审批记录',
  INDEX idx_applicant_id (applicant_id) COMMENT '按申请人查询审批',
  INDEX idx_status (status) COMMENT '按审批状态筛选'
) ENGINE=InnoDB COMMENT='审批主表';

CREATE TABLE approval_node (
  id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '节点ID',
  approval_id BIGINT NOT NULL COMMENT '审批ID',
  node_name VARCHAR(50) NOT NULL COMMENT '节点名称（如：门店经理审批/财务审核）',
  node_seq INT NOT NULL COMMENT '节点顺序（1=第一级，按顺序审批）',
  approver_id BIGINT NOT NULL COMMENT '审批人ID',
  approver_name VARCHAR(50) NOT NULL COMMENT '审批人姓名（冗余）',
  status TINYINT DEFAULT 0 COMMENT '节点状态(0待审批 1通过 2驳回 3转审)',
  action_time DATETIME COMMENT '操作时间',
  comment TEXT COMMENT '审批意见',
  FOREIGN KEY (approval_id) REFERENCES approval(id) ON DELETE CASCADE,
  FOREIGN KEY (approver_id) REFERENCES sys_user(id) ON DELETE RESTRICT,
  INDEX idx_approval_id (approval_id) COMMENT '按审批ID查询节点',
  INDEX idx_approver_id (approver_id) COMMENT '按审批人查询待办节点'
) ENGINE=InnoDB COMMENT='审批节点表（支持多级审批）';

CREATE TABLE approval_transfer (
  id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '转审记录ID',
  approval_id BIGINT NOT NULL COMMENT '审批ID',
  node_id BIGINT NOT NULL COMMENT '原审批节点ID',
  original_approver_id BIGINT NOT NULL COMMENT '原审批人ID',
  target_approver_id BIGINT NOT NULL COMMENT '目标审批人ID',
  transfer_reason VARCHAR(255) COMMENT '转审原因',
  transfer_time DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '转审时间',
  FOREIGN KEY (approval_id) REFERENCES approval(id) ON DELETE CASCADE,
  FOREIGN KEY (node_id) REFERENCES approval_node(id) ON DELETE CASCADE,
  FOREIGN KEY (original_approver_id) REFERENCES sys_user(id) ON DELETE RESTRICT,
  FOREIGN KEY (target_approver_id) REFERENCES sys_user(id) ON DELETE RESTRICT,
  INDEX idx_approval_id (approval_id) COMMENT '按审批ID查询转审记录'
) ENGINE=InnoDB COMMENT='审批转审记录表';

-- ======================================================
--  通用数据字典模块（表名前缀：dict_）
-- ======================================================
CREATE TABLE dict_type (
  id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '字典类型ID',
  dict_type_code VARCHAR(50) NOT NULL UNIQUE COMMENT '字典类型编码（如：store_status/expense_type）',
  dict_type_name VARCHAR(100) NOT NULL COMMENT '字典类型名称（如：门店状态/费用类型）',
  status TINYINT DEFAULT 1 COMMENT '状态(1启用 0禁用)',
  create_time DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  update_time DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  INDEX idx_dict_type_code (dict_type_code) COMMENT '按编码查询字典类型'
) ENGINE=InnoDB COMMENT='数据字典类型表';

CREATE TABLE dict_item (
  id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '字典项ID',
  dict_type_id BIGINT NOT NULL COMMENT '字典类型ID',
  dict_label VARCHAR(50) NOT NULL COMMENT '字典标签（如：启用/活动费）',
  dict_value VARCHAR(50) NOT NULL COMMENT '字典值（如：1/activity）',
  sort INT DEFAULT 0 COMMENT '排序序号',
  status TINYINT DEFAULT 1 COMMENT '状态(1启用 0禁用)',
  create_time DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  update_time DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  FOREIGN KEY (dict_type_id) REFERENCES dict_type(id) ON DELETE CASCADE,
  UNIQUE KEY uk_dict_type_value (dict_type_id, dict_value) COMMENT '同一字典类型下值唯一',
  INDEX idx_dict_type_id (dict_type_id) COMMENT '按字典类型查询字典项'
) ENGINE=InnoDB COMMENT='数据字典项表';
